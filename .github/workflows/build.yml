name: Build and Publish Package

on:
  push:
    branches:
      - 'main'
    tags:
      - 'v*.*.*'
  workflow_dispatch:

concurrency:
  group: build-release-docker
  cancel-in-progress: true

jobs:
  build-artifacts:
    name: Build on ${{ matrix.python-version }} in Docker
    runs-on: ubuntu-latest
    env:
      PYTHONUTF8: "1"
      PYTHONIOENCODING: "utf-8"

    strategy:
      matrix:
        python-version: [ "2.7", "3.12" ]
        # å®šä¹‰å¯¹åº” Python ç‰ˆæœ¬çš„ Docker é•œåƒ
        include:
          - python-version: "2.7"
            docker_image: python:2.7-slim
          - python-version: "3.12"
            docker_image: python:3.12-slim

    container: ${{ matrix.docker_image }} # ä½¿ç”¨çŸ©é˜µä¸­å®šä¹‰çš„é•œåƒä½œä¸ºæ„å»ºç¯å¢ƒ

    steps:
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4

      # åœ¨å®¹å™¨å†…ï¼ŒPYTHON_EXEC å°±æ˜¯ 'python'
      - name: Set PYTHON_EXEC (Container Context)
        run: echo "PYTHON_EXEC=python" >> $GITHUB_ENV

      - name: ğŸ“š Install build dependencies
        run: |
          pip install --upgrade pip
          # å¯¹äº 2.7 å’Œ 3.12ï¼Œæˆ‘ä»¬éœ€è¦ setuptools å’Œ wheel
          pip install setuptools wheel build
        shell: bash

      - name: ğŸ—ï¸ Build Artifacts
        run: |
          if [[ "${{ matrix.python-version }}" == "3.12" ]]; then
            echo "Building sdist and wheel for Python 3.12..."
            # ä½¿ç”¨ build å·¥å…·è¿›è¡Œç°ä»£æ„å»º
            python -m build
          else
            echo "Building sdist for Python 2.7..."
            # 2.7 ç¯å¢ƒä½¿ç”¨ setup.py æ„å»º sdist
            python setup.py bdist_wheel
          fi
        shell: bash

      - name: â¬†ï¸ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          # åŒºåˆ† Artifact åç§°ï¼Œé¿å… 2.7 å’Œ 3.12 çš„äº§ç‰©æ··æ·†
          name: artifacts-py${{ matrix.python-version }}
          path: dist/*
          retention-days: 7

  # --- Job 2: å‘å¸ƒåˆ° PyPI ---
  publish:
    name: Publish to PyPI
    needs: build-artifacts
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/pip-fc
    permissions:
      id-token: write

    steps:
      # 1. ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      - name: Download Py2.7 Artifacts
        uses: actions/download-artifact@v4
        with:
          name: artifacts-py2.7
          path: dist-py27/

      - name: Download Py3.12 Artifacts
        uses: actions/download-artifact@v4
        with:
          name: artifacts-py3.12
          path: dist-py312/

      - name: Merge artifacts for unified publishing
        run: |
          echo "Merging artifacts from build jobs..."
          mkdir -p dist
          # å¤åˆ¶ 2.7 çš„ sdist
          cp -r dist-py27/* dist/
          # å¤åˆ¶ 3.12 çš„ sdist å’Œ wheel (è¦†ç›–åŒå sdist)
          cp -r dist-py312/* dist/
        shell: bash

      # 2. å‡†å¤‡å‘å¸ƒç¯å¢ƒ (ä½¿ç”¨æœ€æ–°çš„ Python 3.x ç¯å¢ƒè¿›è¡Œå‘å¸ƒæ“ä½œ)
      - name: ğŸ Set up Python for Publishing (3.12)
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # 3. å‘å¸ƒåˆ° TestPyPI
      - name: Publish all artifacts to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          print-hash: true
          verbose: true
          repository-url: https://test.pypi.org/legacy/
          password: ${{ secrets.TESTPYPI_API_TOKEN }}

      # 4. å‘å¸ƒåˆ°æ­£å¼ PyPI
      - name: Publish to PyPI (Official Release)
        if: success() && startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-rc')
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
